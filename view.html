<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>臨床通報小幫手｜查閱</title>

  <!-- 內嵌可愛 ICON（粉紫圓＋白色愛心），免檔案 -->
  <link rel="icon" sizes="32x32"
        href='data:image/svg+xml;utf8,
<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256" viewBox="0 0 256 256">
  <defs>
    <radialGradient id="g" cx="50%" cy="40%" r="70%">
      <stop offset="0%" stop-color="#f5e8ff"/>
      <stop offset="100%" stop-color="#c9b6ff"/>
    </radialGradient>
  </defs>
  <circle cx="128" cy="128" r="120" fill="url(#g)"/>
  <path d="M128 174c-20-15-56-37-56-67 0-17 12-30 28-30 11 0 20 6 28 16 8-10 17-16 28-16 16 0 28 13 28 30 0 30-36 52-56 67z" fill="#fff"/>
</svg>' />

  <script src="./config.js"></script>

  <style>
    :root{
      --bg:#faf7ff;--card:#fff;--ink:#2f2a3b;--muted:#6b6280;
      --primary:#7c5cff;--primary-weak:#efeaff;--ring:#e9e2ff;
      --shadow:0 12px 28px rgba(124,92,255,.14);--radius:18px;
      --tableHeightOffset: 220px; /* 視窗高扣除（視需要微調） */
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC",Arial}

    /* 頁首 */
    .top{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#fff8ff,rgba(255,255,255,.85));backdrop-filter:blur(6px);border-bottom:1px solid var(--ring)}
    .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:36px;height:36px;border-radius:10px;object-fit:cover;box-shadow:0 2px 6px rgba(0,0,0,.12)}
    .brand span{font-weight:800;font-size:20px;color:#2f2a3b}
    .nav{margin-left:auto;display:flex;gap:8px}
    .btn{text-decoration:none;background:#efeaff;color:#7c5cff;padding:8px 12px;border-radius:12px;font-weight:800;border:1px solid #efeaff}
    .btn.ghost{background:#fff;border-color:#e9e2ff}

    /* 控制列 */
    .controls{display:flex;gap:10px;align-items:center;margin:12px 0;flex-wrap:wrap}
    input,select{padding:10px 12px;border:1.2px solid var(--ring);border-radius:12px;outline:none;background:#fff}
    input:focus,select:focus{border-color:var(--primary);box-shadow:0 0 0 4px var(--primary-weak)}
    .spacer{flex:1}

    /* 表格容器（可滾動），表頭 sticky */
    .table-wrap{
      background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);
      box-shadow:var(--shadow);overflow:auto;
      max-height: calc(100vh - var(--tableHeightOffset));
    }

    /* 固定欄寬與換行友善 */
    table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed;min-width:1200px}
    thead th{
      position:sticky; top:0; z-index:5;
      background:#f7f4ff; color:var(--muted); font-size:12px;
      text-align:left; padding:10px 12px; border-bottom:1px solid var(--ring); white-space:nowrap;
      box-shadow:0 2px 0 #ece6ff;
    }
    tbody td{
      padding:10px 12px;border-bottom:1px solid #f2ecff;vertical-align:top;font-size:14px;background:#fff;
      word-wrap:break-word;overflow-wrap:anywhere;
    }
    td.long{font-size:13px;line-height:1.45} /* 長文欄位較小字、緊湊行距 */
    tbody tr:nth-child(odd) td{background:#fefcff}
    tbody tr:hover td{background:#fbf7ff}
  </style>
</head>
<body>
  <!-- 頂部導覽 -->
  <div class="top">
    <div class="wrap" style="display:flex;align-items:center;gap:12px">
      <div class="brand">
        <img alt="App Icon"
             src='data:image/svg+xml;utf8,
<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256" viewBox="0 0 256 256">
  <defs>
    <radialGradient id="g" cx="50%" cy="40%" r="70%">
      <stop offset="0%" stop-color="#f5e8ff"/>
      <stop offset="100%" stop-color="#c9b6ff"/>
    </radialGradient>
  </defs>
  <circle cx="128" cy="128" r="120" fill="url(#g)"/>
  <path d="M128 174c-20-15-56-37-56-67 0-17 12-30 28-30 11 0 20 6 28 16 8-10 17-16 28-16 16 0 28 13 28 30 0 30-36 52-56 67z" fill="#fff"/>
</svg>'>
        <span>臨床通報小幫手</span>
      </div>
      <div class="nav">
        <a class="btn" href="./index.html">填報</a>
        <a class="btn ghost" href="./view.html">查閱</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="controls">
      <input id="q" placeholder="搜尋關鍵字（人名、單位、內容…）" oninput="load()">
      <select id="limit" onchange="load()">
        <option value="20">最近 20 筆</option>
        <option value="50" selected>最近 50 筆</option>
        <option value="100">最近 100 筆</option>
      </select>
      <div class="spacer"></div>
      <a id="sheet" target="_blank" style="text-decoration:none;color:#7c5cff;font-weight:800">前往試算表 ↗</a>
    </div>

    <!-- colgroup 控制欄寬：左側資訊窄；右側三欄加寬 -->
    <div class="table-wrap">
      <table id="tbl">
        <colgroup>
          <col style="width:110px"><!-- 通報日期 -->
          <col style="width:90px"><!-- 類別 -->
          <col style="width:95px"><!-- 傷害程度 -->
          <col style="width:110px"><!-- 病歷號 -->
          <col style="width:100px"><!-- 病人姓名 -->
          <col style="width:110px"><!-- 入院日 -->
          <col style="width:88px"><!-- 住院天數 -->
          <col style="width:120px"><!-- 單位/床號（自由文字） -->
          <col style="width:100px"><!-- 主要因素 -->
          <col style="width:420px"><!-- 通報內容（拉寬） -->
          <col style="width:320px"><!-- 護理措施（拉寬） -->
          <col style="width:300px"><!-- 建議措施（拉寬） -->
        </colgroup>
        <thead>
          <tr>
            <th>通報日期</th>
            <th>類別</th>
            <th>傷害程度</th>
            <th>病歷號</th>
            <th>病人姓名</th>
            <th>入院日</th>
            <th>住院天數</th>
            <th>單位/床號</th>
            <th>主要因素</th>
            <th>通報內容</th>
            <th>護理措施</th>
            <th>建議措施</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    if (typeof GAS_URL === 'undefined') {
      alert('config.js 未載入，請確認檔案與 GAS_URL 設定');
    }

    const COLS = [
      '通報日期','類別','傷害程度','病歷號','病人姓名',
      '入院日','住院天數','單位/床號','主要因素',
      '通報內容','護理措施','建議措施'
    ];

    function toDateString(v){
      if (!v) return '';
      const s = String(v);
      const first10 = s.length >= 10 ? s.slice(0,10) : s;
      let m = /^(\d{4})[-/](\d{2})[-/](\d{2})$/.exec(first10);
      if (m){
        const d = new Date(+m[1], +m[2]-1, +m[3]);
        const y=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
        return `${y}/${mm}/${dd}`;
      }
      const d2 = new Date(s);
      if (!isNaN(d2)) {
        const y=d2.getFullYear(), mm=String(d2.getMonth()+1).padStart(2,'0'), dd=String(d2.getDate()).padStart(2,'0');
        return `${y}/${mm}/${dd}`;
      }
      return s;
    }
    function toTime(v){
      const s = toDateString(v);
      const m = /^(\d{4})\/(\d{2})\/(\d{2})$/.exec(s);
      if (m) return new Date(+m[1], +m[2]-1, +m[3]).getTime();
      const d = new Date(v); return isNaN(d)?0:d.getTime();
    }

    async function load(){
      try{
        const u = new URL(GAS_URL);
        u.searchParams.set('action','list');
        u.searchParams.set('limit', document.getElementById('limit').value);
        u.searchParams.set('query', document.getElementById('q').value.trim());
        const r = await fetch(u,{cache:'no-store'});
        const { ok, rows, sheetUrl, error } = await r.json();
        if(!ok) throw new Error(error || 'API 回傳失敗');
        document.getElementById('sheet').href = sheetUrl;

        // 由新到舊
        const sorted = (rows||[]).slice().sort((a,b)=> toTime(b['通報日期']) - toTime(a['通報日期']));

        const tb = document.querySelector('#tbl tbody');
        tb.innerHTML = '';
        sorted.forEach(row=>{
          const tds = COLS.map(key=>{
            let v = row[key] ?? '';
            if (key==='通報日期' || key==='入院日') v = toDateString(v);
            const long = (key==='通報內容'||key==='護理措施'||key==='建議措施') ? 'long' : '';
            return `<td class="${long}">${v}</td>`;
          }).join('');
          tb.insertAdjacentHTML('beforeend', `<tr>${tds}</tr>`);
        });
      }catch(e){
        console.error(e);
        alert('載入失敗：' + e.message);
      }
    }
    document.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>
