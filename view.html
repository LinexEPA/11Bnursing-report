<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>臨床通報小幫手｜查閱</title>
  <script src="./config.js"></script>
  <style>
    :root{
      --bg:#faf7ff; --card:#ffffff; --ink:#2f2a3b; --muted:#6b6280;
      --primary:#7c5cff; --primary-weak:#efeaff; --ring:#e9e2ff;
      --shadow:0 10px 24px rgba(124,92,255,.12); --radius:18px;
      --badge:#fff0f5; --badgeText:#d9487d;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC",Arial}
    .top{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fff8ff,rgba(255,255,255,.85));backdrop-filter:blur(6px);border-bottom:1px solid var(--ring)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{font-size:20px;margin:0}
    .nav{margin-left:auto}
    .nav a{color:var(--primary);text-decoration:none;font-weight:800;background:var(--primary-weak);padding:8px 12px;border-radius:12px}
    .ctrl{
      display:flex;gap:10px;align-items:center;margin:10px 0;flex-wrap:wrap
    }
    input,select{
      padding:10px 12px;border:1.2px solid var(--ring);border-radius:12px;outline:none;background:#fff
    }
    input:focus,select:focus{border-color:var(--primary); box-shadow:0 0 0 4px var(--primary-weak)}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;border:1px solid var(--ring)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      position:sticky;top:64px;z-index:5;background:#fdfbff;color:var(--muted);
      font-size:12px;text-align:left;padding:12px;border-bottom:1px solid var(--ring)
    }
    tbody td{
      padding:12px;border-bottom:1px solid #f2ecff; vertical-align:top; font-size:14px
    }
    tbody tr:nth-child(odd){background:#fefcff}
    tbody tr:hover{background:#fbf7ff}
    .w-time{width:160px} .w-cat{width:110px} .w-sev{width:110px} .w-id{width:120px}
    .nowrap{white-space:nowrap}
    .pre{white-space:pre-wrap}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--badge);color:var(--badgeText);font-weight:700;font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--primary-weak);color:var(--primary);font-weight:700;font-size:12px;margin-left:6px}
    .spacer{flex:1}
  </style>
</head>
<body>
  <div class="top">
    <div class="wrap" style="display:flex;align-items:center;gap:12px">
      <h1>臨床通報小幫手</h1><span class="pill">查閱</span>
      <div class="spacer"></div>
      <div class="nav"><a href="./index.html">填報</a></div>
    </div>
  </div>

  <div class="wrap">
    <div class="ctrl">
      <input id="q" placeholder="搜尋關鍵字（人名、單位、內容…）" oninput="load()">
      <select id="limit" onchange="load()">
        <option value="20">最近 20 筆</option>
        <option value="50" selected>最近 50 筆</option>
        <option value="100">最近 100 筆</option>
      </select>
      <div class="spacer"></div>
      <a id="sheet" target="_blank" style="text-decoration:none;color:var(--primary);font-weight:800">前往試算表 ↗</a>
    </div>

    <div class="card">
      <table id="tbl">
        <thead>
          <tr>
            <th class="w-time">通報日期</th>
            <th class="w-cat">類別</th>
            <th class="w-sev">傷害程度</th>
            <th class="w-id">病歷號</th>
            <th class="w-id">病人姓名</th>
            <th class="w-time">入院日</th>
            <th class="w-sev">住院天數</th>
            <th class="w-id">單位/床號</th>
            <th class="w-id">主要因素</th>
            <th>通報內容</th>
            <th>護理措施</th>
            <th>建議措施</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    if (typeof GAS_URL === 'undefined'){
      alert('未設定 GAS_URL，請到 config.js 放入 Apps Script 的 /exec 網址');
    }

    function fmtDate(v){
      try{ const d = new Date(v); if(isNaN(d)) return v; return d.toLocaleString(); }
      catch(e){ return v; }
    }

    async function load(){
      try{
        const u = new URL(GAS_URL);
        u.searchParams.set('action','list');
        u.searchParams.set('limit', document.getElementById('limit').value);
        u.searchParams.set('query', document.getElementById('q').value.trim());
        const res = await fetch(u);
        const { ok, rows, sheetUrl } = await res.json();
        if(!ok) throw new Error('API 回傳失敗');
        document.getElementById('sheet').href = sheetUrl;

        const tb = document.querySelector('#tbl tbody');
        tb.innerHTML = '';
        (rows||[]).forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="nowrap">${fmtDate(r['通報日期'])}</td>
            <td><span class="badge">${r['類別']||''}</span></td>
            <td><span class="badge">${r['傷害程度']||''}</span></td>
            <td class="nowrap">${r['病歷號']||''}</td>
            <td class="nowrap">${r['病人姓名']||''}</td>
            <td class="nowrap">${fmtDate(r['入院日'])}</td>
            <td class="nowrap">${r['住院天數']||''}</td>
            <td class="nowrap">${r['單位/床號']||''}</td>
            <td class="nowrap">${r['主要因素']||''}</td>
            <td class="pre">${r['通報內容']||''}</td>
            <td class="pre">${r['護理措施']||''}</td>
            <td class="pre">${r['建議措施']||''}</td>
          `;
          tb.appendChild(tr);
        });
      }catch(err){
        console.error(err);
        alert('載入失敗，請檢查 GAS_URL / 權限。');
      }
    }

    load();
    // 溫和自動刷新
    setInterval(load, 15000);
  </script>
</body>
</html>
